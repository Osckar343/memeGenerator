<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Node Website</title>
    <%- include ('partials/head.html')%>
    <link rel="stylesheet" href="/css/image-picker.css">
    <script src="https://www.lactame.com/lib/image-js/0.21.2/image.min.js"></script>
</head>
<body>
 
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
         <a class="navbar-brand" href="/">MemeUrlGenerator</a>
         <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
             aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
             <span class="navbar-toggler-icon"></span>
         </button>
         <div class="collapse navbar-collapse" id="navbarNav">
             <ul class="navbar-nav ml-auto">
                 <li class="nav-item active">
                    <a class="nav-link disabled">Start</a>
                 </li>
                 <li class="nav-item">
                     <a class="nav-link">Searching<span class="sr-only">(current)</span></a>
                 </li>
                 <li class="nav-item active">
                    <a class="nav-link"> -> <span class="sr-only">(current)</span></a>
                </li>
                 <li class="nav-item">
                     <a class="nav-link">Filter</a>
                 </li>
             </ul>
         </div>
        </div>
     </nav>

    
    <% var aux = []; %>
    <% for (let i = 0; i < info.results.length; i++) { %>
        <% aux.push( info.results[i].url.replace(/,/g,'¿') ); %> 
    <%} %>

    <% console.log(aux); %>
    
    <div id="container">
        <div id="gallery">
            <!--All results images from the search will print here-->
        </div>

        <button type="button" class="btn btn-info" onclick="generateInfo()">Generate File</button>
    </div>
    
    <div class="container-fluid" id="about">
        <div class="row bg-dark text-white p-5 text-center">
            <div class="col-sm-6">
                <i class="fab fa-youtube fa-10x"></i>
            </div>
            <div class="col-sm-6">
                <h3>URL Memeify Generator</h3>
                <p>A simple meme web searcher, created to complement the discord bot Memeify. <br>By Óscar Méndez.</p>
            </div>
        </div>
    </div>
</body>

<script src="/js/FileSaver.js"></script>

<script>
    function generateInfo () {
        const images = getImagesData();
        const selected = getSelectedImages();
        const newArrayImages = deleteSelectedImages(images,selected);
        
        const topic = getTopicData();
        
        generateFile(topic, newArrayImages);
    }

    function getImagesData () {
        let content = "<%- aux %>";
        const array = content.split(',');

        return array;
    }

    function getTopicData () {
        const topic = "<%= info.topic %>";
        return topic;
    }

    function getSelectedImages () {
        const input = document.getElementsByName('images[]');
        const arraySelected = [];

        for (let i = 0; i < input.length; i++) {
            if(input[i].checked)
                arraySelected.push(input[i].value);
        }

        return arraySelected;
    }

    function deleteSelectedImages (images, selected) {
        const newArrayImages = [];

        for (let i = 0; i < images.length; i++) {
            console.log(selected[i] + ' = ' + i.toString());
            if(!selected.includes(i.toString()))
                newArrayImages.push(images[i]); 
        } 
        return newArrayImages;
    }

    function generateFile (topic, info) {
        const fileName = topic + '.txt';
        
        var blob = new Blob([info],
                { type: "text/plain;charset=utf-8" });
            saveAs(blob, fileName);
    }

    function test ( ) {         
        let content = "<%= aux %>";
        const array = content.split(',');

        const originalSize = "<%= aux.length %>";
        const newSize = array.length;

        for (let i = 0; i < array.length; i++) {
            array[i] = array[i].replace(/¿/g,','); //-- Reconvert (¿) to (,) -->
            console.log((i + 1) + ' ' + array[i]);
        }

        console.log('Original size is: ' + originalSize);
        console.log('New Size is: ' + newSize);

        return array;
    }

    function print (array) {
        let html = '<ul>';

        for (let i = 0; i < array.length; i++) {
            html  += '<li><input type="checkbox" name="images[]" id="cb' + i + '" value="' + i + '"/>';
                html += '<label for="cb' + i + '"><img src="' + array[i] + '" /></label>';
            html += '</li>';
        }
        html += '</ul>';
        document.getElementById('gallery').innerHTML = html;
    }

    let images = test();
    print(images);

 </script>
</html>